{"version":3,"file":"outline_editor.min.js","sources":["../src/outline_editor.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * AMD module for the outline editor in the course review step.\n *\n * Provides interactive add/remove of modules and lessons in the generated\n * course outline before final course creation.\n *\n * @module     local_lumination/outline_editor\n * @copyright  2026 Lumination AI <https://lumination.ai>\n * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Escape HTML special characters to prevent XSS.\n *\n * @param {string} s The string to escape.\n * @returns {string} The escaped string.\n */\nconst escapeHtml = (s) => {\n    const d = document.createElement('div');\n    d.textContent = s;\n    return d.innerHTML;\n};\n\n/**\n * Initialise the outline editor.\n *\n * @param {object} params Configuration parameters.\n * @param {object} params.strings Localised UI strings.\n * @param {string} params.strings.module Module label.\n * @param {string} params.strings.lesson Lesson label.\n * @param {string} params.strings.addmodule Add-module button text.\n * @param {string} params.strings.removemodule Remove-module button text.\n * @param {string} params.strings.addlesson Add-lesson button text.\n * @param {string} params.strings.removelesson Remove-lesson button text.\n * @param {string} params.strings.generatingcourse Loading overlay title.\n * @param {string} params.strings.generatingcourse_desc Loading overlay description.\n */\nexport const init = (params) => {\n    const STRINGS = params.strings;\n    const container = document.getElementById('lumination-outline-editor');\n    const hiddenField = document.querySelector('input[name=outline_json]');\n    if (!container || !hiddenField) {\n        return;\n    }\n\n    let modules;\n    try {\n        modules = JSON.parse(hiddenField.value);\n    } catch (e) {\n        modules = [];\n    }\n\n    /**\n     * Render the outline editor UI from the modules array.\n     */\n    const render = () => {\n        container.innerHTML = '';\n        modules.forEach((mod, mi) => {\n            const card = document.createElement('div');\n            card.className = 'lumination-module card mb-3';\n            card.innerHTML =\n                '<div class=\"card-header d-flex justify-content-between align-items-center\">' +\n                    '<span class=\"font-weight-bold\">' + STRINGS.module + ' ' + (mi + 1) + '</span>' +\n                    '<button type=\"button\" class=\"btn btn-sm btn-outline-danger lum-remove-module\" data-index=\"' +\n                        mi + '\">' +\n                        STRINGS.removemodule + '</button>' +\n                '</div>' +\n                '<div class=\"card-body\"></div>';\n            const body = card.querySelector('.card-body');\n\n            // Module title.\n            const titleGroup = document.createElement('div');\n            titleGroup.className = 'form-group mb-3';\n            titleGroup.innerHTML =\n                '<label class=\"font-weight-bold\">' + STRINGS.module + ' title</label>' +\n                '<input type=\"text\" class=\"form-control lum-module-title\" data-module=\"' + mi +\n                '\" value=\"' + escapeHtml(mod.title || '') + '\">';\n            body.appendChild(titleGroup);\n\n            // Lessons.\n            (mod.lessons || []).forEach((lesson, li) => {\n                const row = document.createElement('div');\n                row.className = 'input-group mb-2 lum-lesson-row';\n                row.innerHTML =\n                    '<div class=\"input-group-prepend\">' +\n                        '<span class=\"input-group-text\">' + STRINGS.lesson + ' ' + (li + 1) + '</span>' +\n                    '</div>' +\n                    '<input type=\"text\" class=\"form-control lum-lesson-title\" data-module=\"' + mi +\n                    '\" data-lesson=\"' + li + '\" value=\"' + escapeHtml(lesson.title || '') + '\">' +\n                    '<div class=\"input-group-append\">' +\n                        '<button type=\"button\" class=\"btn btn-outline-danger btn-sm lum-remove-lesson\" ' +\n                        'data-module=\"' + mi + '\" data-lesson=\"' + li + '\">&times;</button>' +\n                    '</div>';\n                body.appendChild(row);\n            });\n\n            // Add lesson button.\n            const addLessonBtn = document.createElement('button');\n            addLessonBtn.type = 'button';\n            addLessonBtn.className = 'btn btn-sm btn-outline-secondary mt-1 lum-add-lesson';\n            addLessonBtn.textContent = '+ ' + STRINGS.addlesson;\n            addLessonBtn.setAttribute('data-module', mi);\n            body.appendChild(addLessonBtn);\n\n            container.appendChild(card);\n        });\n\n        // Add module button.\n        const addModBtn = document.createElement('button');\n        addModBtn.type = 'button';\n        addModBtn.className = 'btn btn-outline-primary mb-3 lum-add-module';\n        addModBtn.textContent = '+ ' + STRINGS.addmodule;\n        container.appendChild(addModBtn);\n    };\n\n    /**\n     * Synchronise input values back into the modules array and update the hidden field.\n     */\n    const sync = () => {\n        container.querySelectorAll('.lumination-module').forEach((card, mi) => {\n            if (!modules[mi]) {\n                return;\n            }\n            const titleInput = card.querySelector('.lum-module-title');\n            if (titleInput) {\n                modules[mi].title = titleInput.value;\n            }\n            const lessonInputs = card.querySelectorAll('.lum-lesson-title');\n            lessonInputs.forEach((inp, li) => {\n                if (modules[mi].lessons && modules[mi].lessons[li]) {\n                    modules[mi].lessons[li].title = inp.value;\n                }\n            });\n        });\n        hiddenField.value = JSON.stringify(modules);\n    };\n\n    // Event delegation.\n    container.addEventListener('click', (e) => {\n        const btn = e.target.closest('button');\n        if (!btn) {\n            return;\n        }\n\n        sync();\n\n        if (btn.classList.contains('lum-add-module')) {\n            modules.push({title: '', lessons: [{title: ''}]});\n            render();\n        } else if (btn.classList.contains('lum-remove-module')) {\n            if (modules.length <= 1) {\n                return;\n            }\n            modules.splice(parseInt(btn.dataset.index), 1);\n            render();\n        } else if (btn.classList.contains('lum-add-lesson')) {\n            const mi = parseInt(btn.dataset.module);\n            modules[mi].lessons.push({title: ''});\n            render();\n        } else if (btn.classList.contains('lum-remove-lesson')) {\n            const mi = parseInt(btn.dataset.module);\n            const li = parseInt(btn.dataset.lesson);\n            if (modules[mi].lessons.length <= 1) {\n                return;\n            }\n            modules[mi].lessons.splice(li, 1);\n            render();\n        }\n        sync();\n    });\n\n    container.addEventListener('input', () => {\n        sync();\n    });\n\n    // Loading overlay on form submit.\n    const form = container.closest('form');\n    if (form) {\n        form.addEventListener('submit', () => {\n            sync();\n            const overlay = document.createElement('div');\n            overlay.id = 'lumination-loading-overlay';\n            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);' +\n                'z-index:9999;display:flex;align-items:center;justify-content:center;';\n            overlay.innerHTML =\n                '<div style=\"background:#fff;border-radius:8px;padding:2rem 3rem;' +\n                    'text-align:center;max-width:420px;\">' +\n                    '<div class=\"spinner-border text-primary mb-3\" role=\"status\">' +\n                        '<span class=\"sr-only\">Loading...</span></div>' +\n                    '<h4>' + escapeHtml(STRINGS.generatingcourse) + '</h4>' +\n                    '<p class=\"text-muted mb-0\">' + escapeHtml(STRINGS.generatingcourse_desc) + '</p>' +\n                '</div>';\n            document.body.appendChild(overlay);\n        });\n    }\n\n    render();\n    sync();\n};\n"],"names":["escapeHtml","s","d","document","createElement","textContent","innerHTML","params","STRINGS","strings","container","getElementById","hiddenField","querySelector","modules","JSON","parse","value","e","render","forEach","mod","mi","card","className","module","removemodule","body","titleGroup","title","appendChild","lessons","lesson","li","row","addLessonBtn","type","addlesson","setAttribute","addModBtn","addmodule","sync","querySelectorAll","titleInput","inp","stringify","addEventListener","btn","target","closest","classList","contains","push","length","splice","parseInt","dataset","index","form","overlay","id","style","cssText","generatingcourse","generatingcourse_desc"],"mappings":"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"}